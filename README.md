# CuttleFlow

CuttleFlow is a tool that rewrites Data Analysis Workflows (DAW) according to their execution context (input data and computer/cluster the DAW is running on).
It can replace tools with similar ones where appropriate, while maintaining the workflow structure and outputs.
It can parallelize some tasks across multiple nodes of a cluster when appropriate, depending on the execution context.
It will set the appropriate number of threads on the DAW tasks.
To run our program on the *rnasplice* workflow, run the following commands
```
bash cuttleflow.sh --descriptionFolder test/rnasplice-description --output ../generated_daw_rnasplice_test
```

By changing the `--description folder` argument, you can load a different workflow, input and infrastructure description. 
You can change the output folder where the DAW is generated by changing the path of the `--output` argument.

For more information on the rnasplice workflow, visit the nf-core [website](https://nf-co.re/rnasplice/1.0.4).

## Output

The following folder is generated from the above command:
```
generated_daw_rnasplice_test
|-- input.csv
|-- main.nf
|-- nextflow.config
```

`main.nf` contains the DAW's Nextflow code and the path to the module.
`nextflow.config` contains the parameters needed to run the DAW. By default, we include the generation of trace files containing metrics on the DAW execution.
`input.csv` contains the path and metadata and input data required to run the DAW.

## Executing the ouput DAW

You can run the DAW with this command:
`nextflow run main.nf -c nextflow.config`.

You need to edit the `INPUT.json` and `INFRA.json` files to be able to run the DAW on your data and infrastructure.

For more information about Nextflow, visit their [website](https://www.nextflow.io/docs/latest/index.html).

## Containerization using Docker
The `docker` folder contains the `Dockerfile` to create a container to run CuttleFlow. The file `requirements.txt` contains a list of all python packages needed to execute CuttleFlow. To create the Docker image, run 
```
docker build -t cuttleflow ./docker
```
(Please note: the `requirements.txt` file needs to be in the same folder as the `Dockerfile`.)
Then, to start a container using this image, run 
```
docker run -it cuttleflow
```
This command starts a command line interface in a virtual ubuntu environment. The CuttleFlow code can be found in the folder `/home/ubuntu/CuttleFlow`.

## Creating your own description files

The description files consist of
```
description_folder
|-- DAW.json
|-- INFRA.json
|-- INPUT.json
|-- SPLIT_MERGE_TASKS.json
```

- DAW.json' contains the DAW declaration, including the inputs and outputs of the various tasks, and the path to the Nextflow modules to be used.
- INFRA.json' contains the description of the machine or cluster you want to run your workflow on.
- INPUT.json' contains information about your input data and its paths.
- SPLIT_MERGE_TASKS.json is a file that you will need to edit to add your own parallelisation logic.

## Adding tool annotations

If you have annotated some bio-tools so that they can be replaced or split by CuttleFlow, please edit the following files

- `source/annotation_files/infrastructure_runtime`: add a description of the infrastructure you ran your tool on.
- `source/annotation_files/': add the description of your tool here. 
- source/annotation_files/runtime_aligners.csv': add the runtime of your tool here


## Reproduction package

Will be done the 5th of June! 
